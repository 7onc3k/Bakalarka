{
  "body": "## 1. Requirements\n\n*Problem domain — WHAT the business needs*\n\n### Description\n\nA standalone npm package implementing a dunning system (automated billing reminder workflow) as pure business logic. The system automatically escalates unpaid invoices through a series of states — from a friendly due-soon reminder, through increasingly urgent notices, to service suspension and eventual write-off.\n\nEach invoice has an independent dunning instance. The package contains no infrastructure dependencies — it returns action descriptors (send email, suspend service, schedule next check) rather than performing them. Timeouts are calculated in business days (excluding weekends and public holidays).\n\nThe system supports configurable timeouts per dunning instance, configurable public holidays for business day calculations, manual overrides (pause, resume, force advance), and invoice cancellation at any point.\n\n### Technical Requirements\n\n- **Language:** TypeScript (strict mode, ESM — `\"type\": \"module\"` in package.json)\n- **Runtime:** Node.js (LTS)\n- **Test framework:** Vitest\n- **Output:** publishable npm package with type declarations (`.d.ts`)\n\n### Package API\n\nThe package must export:\n\n- A function to initialize a new dunning instance given an invoice due date and optional configuration\n- A pure function `process(state, event, now)` — takes current dunning state, an event, and current date; returns `{ state, actions }`\n\n**Events:** `tick` (check for time-based transitions), `payment_received`, `invoice_cancelled`, `dunning_paused`, `dunning_resumed`, `manual_advance`\n\n**Returned state** must expose the current status as a string (e.g. `state.status`).\n\n**Action descriptors** must be plain objects with a `type` field (e.g. `{ type: 'send_email', template: '...' }`).\n\nInternal implementation (types, modules, class vs. functional style) is not constrained.\n\n### Acceptance Criteria\n\n**Time-based transitions (happy path escalation):**\n\n- Given an invoice is in ISSUED state\n  When 7 business days before the due date is reached\n  Then the state transitions to DUE_SOON\n  And an action descriptor `send_email(due_soon_reminder)` is returned\n\n- Given an invoice is in DUE_SOON state\n  When the due date is reached\n  Then the state transitions to OVERDUE\n\n- Given an invoice is in OVERDUE state\n  When 3 business days have elapsed\n  Then the state transitions to GRACE\n\n- Given an invoice is in GRACE state\n  When 7 business days have elapsed\n  Then the state transitions to REMINDER_1\n  And an action descriptor `send_email(first_reminder)` is returned\n\n- Given an invoice is in REMINDER_1 state\n  When 14 business days have elapsed\n  Then the state transitions to REMINDER_2\n  And an action descriptor `send_email(second_reminder)` is returned\n\n- Given an invoice is in REMINDER_2 state\n  When 14 business days have elapsed\n  Then the state transitions to FINAL_NOTICE\n  And an action descriptor `send_email(final_warning)` is returned\n\n- Given an invoice is in FINAL_NOTICE state\n  When 7 business days have elapsed\n  Then the state transitions to SUSPENDED\n  And action descriptors `suspend_service()` and `send_email(service_suspended)` are returned\n\n- Given an invoice is in SUSPENDED state\n  When 30 business days have elapsed\n  Then the state transitions to WRITTEN_OFF\n  And an action descriptor `send_email(written_off_notice)` is returned\n\n**Payment (resolves dunning at any point):**\n\n- Given an invoice is in any state except WRITTEN_OFF, PAID, and CANCELLED\n  When a `payment_received` event occurs\n  Then the state transitions to PAID\n\n- Given an invoice was in SUSPENDED state\n  When a `payment_received` event transitions it to PAID\n  Then an action descriptor `resume_service()` is returned in addition to the transition\n\n**Terminal states:**\n\n- Given an invoice is in PAID state\n  When any event occurs\n  Then no state transition happens\n\n- Given an invoice is in WRITTEN_OFF state\n  When any event occurs\n  Then no state transition happens\n\n- Given an invoice is in CANCELLED state\n  When any event occurs\n  Then no state transition happens\n\n**Invoice cancellation:**\n\n- Given an invoice is in any state except PAID, WRITTEN_OFF, and CANCELLED\n  When an `invoice_cancelled` event occurs\n  Then the state transitions to CANCELLED\n\n- Given an invoice was in SUSPENDED state\n  When an `invoice_cancelled` event transitions it to CANCELLED\n  Then an action descriptor `resume_service()` is returned\n\n**Pause / Resume (manual override):**\n\n- Given an invoice is in any active dunning state (OVERDUE, GRACE, REMINDER_1, REMINDER_2, FINAL_NOTICE, SUSPENDED)\n  When a `dunning_paused` event occurs\n  Then the state transitions to PAUSED\n  And the previous state and elapsed time are preserved\n\n- Given an invoice is in PAUSED state\n  When a `dunning_resumed` event occurs\n  Then the state transitions back to the state it was in before pausing\n  And the timeout resumes from where it left off\n\n- Given an invoice is in PAUSED state\n  When a `payment_received` event occurs\n  Then the state transitions to PAID (payment always takes priority)\n\n- Given an invoice is in PAUSED state\n  When an `invoice_cancelled` event occurs\n  Then the state transitions to CANCELLED\n\n**Manual advance:**\n\n- Given an invoice is in any active dunning state\n  When a `manual_advance` event occurs\n  Then the state transitions to the next state in the escalation sequence\n  And the appropriate action descriptors for that transition are returned\n\n**Configurable timeouts:**\n\n- Given a dunning instance is created with custom timeout configuration\n  When time-based transitions are evaluated\n  Then the custom timeouts are used instead of the defaults\n\n- Given no custom timeout configuration is provided\n  When a dunning instance is created\n  Then the default timeouts are used (DUE_SOON: 7d before due, OVERDUE→GRACE: 3bd, GRACE→REMINDER_1: 7bd, REMINDER_1→REMINDER_2: 14bd, REMINDER_2→FINAL_NOTICE: 14bd, FINAL_NOTICE→SUSPENDED: 7bd, SUSPENDED→WRITTEN_OFF: 30bd)\n\n**Business days calculation:**\n\n- Given a timeout of 14 business days starting on a Friday\n  When the system calculates the target date\n  Then weekends (Saturday, Sunday) are excluded from the count\n\n- Given a public holiday falls within a timeout period\n  When the system calculates the target date\n  Then the public holiday is excluded from the count\n\n- Given a custom holiday calendar is provided\n  When business days are calculated\n  Then the custom holidays are used\n\n### Domain Glossary\n\n- **Dunning** — the process of escalating unpaid invoices through a series of reminders\n- **Dunning instance** — an independent dunning process for a single invoice\n- **Grace period** — a waiting period after the due date to account for bank transfer delays (1-3 days)\n- **Business days** — working days excluding weekends and public holidays\n- **Due date** — the payment deadline on an invoice\n- **Suspension** — disabling services for the client as a consequence of non-payment\n- **Write-off** — marking a receivable as uncollectible; terminal state handled outside the system\n- **Action descriptor** — a plain object describing what the consuming application should do (e.g. send email, suspend service), without performing it\n- **Holiday calendar** — a configurable list of public holidays for business day calculations\n\n### Out of Scope\n\nThe following are explicitly **not** part of this package:\n- **Payment retry** (e.g. Stripe retry) — infrastructure concern\n- **Late fees / interest calculation** — separate accounting concern\n- **Partial payments** — would require threshold/credit logic, out of scope\n- **Email sending** — the package returns action descriptors, not performs them\n- **Scheduling / cron** — the consuming application decides when to evaluate timeouts\n- **Database persistence** — the consuming application manages state storage\n\n\n## 2. API Contract\n\n*Implementation contract — WHAT you must export*\n\nYour package must export exactly these functions and types. The names, signatures, and type shapes are fixed — the behavioral test suite depends on them.\n\n### Exported Functions\n\n```typescript\n// Initialize a new dunning instance\nexport function createInstance(\n  dueDate: Date,\n  config?: Partial<DunningConfig>\n): DunningState\n\n// Pure state transition function\nexport function process(\n  state: DunningState,\n  event: DunningEvent,\n  now: Date\n): ProcessResult\n```\n\n### Types\n\n```typescript\ntype DunningStatus =\n  | \"ISSUED\" | \"DUE_SOON\" | \"OVERDUE\" | \"GRACE\"\n  | \"REMINDER_1\" | \"REMINDER_2\" | \"FINAL_NOTICE\"\n  | \"SUSPENDED\" | \"WRITTEN_OFF\" | \"PAID\" | \"PAUSED\" | \"CANCELLED\"\n\ntype EventType =\n  | \"tick\" | \"payment_received\" | \"invoice_cancelled\"\n  | \"dunning_paused\" | \"dunning_resumed\" | \"manual_advance\"\n\ninterface DunningEvent {\n  type: EventType\n}\n\ntype ActionType = \"send_email\" | \"suspend_service\" | \"resume_service\"\n\ninterface ActionDescriptor {\n  type: ActionType\n  template?: string  // only for send_email\n}\n\ninterface DunningConfig {\n  timeouts?: Partial<Record<DunningStatus, number>>\n  holidays?: Date[]\n}\n\ninterface DunningState {\n  status: DunningStatus\n  dueDate: Date\n  stateEnteredAt: Date\n  config: DunningConfig\n  pausedFrom?: DunningStatus   // set when status === \"PAUSED\"\n  pausedElapsed?: number       // business days elapsed before pause\n}\n\ninterface ProcessResult {\n  state: DunningState\n  actions: ActionDescriptor[]\n}\n```\n\n### Action Templates per Transition\n\n| Transition | Actions |\n|-----------|---------|\n| → DUE_SOON | `{ type: \"send_email\", template: \"due_soon_reminder\" }` |\n| → REMINDER_1 | `{ type: \"send_email\", template: \"first_reminder\" }` |\n| → REMINDER_2 | `{ type: \"send_email\", template: \"second_reminder\" }` |\n| → FINAL_NOTICE | `{ type: \"send_email\", template: \"final_warning\" }` |\n| → SUSPENDED | `{ type: \"suspend_service\" }` + `{ type: \"send_email\", template: \"service_suspended\" }` |\n| → WRITTEN_OFF | `{ type: \"send_email\", template: \"written_off_notice\" }` |\n| payment from SUSPENDED | also `{ type: \"resume_service\" }` |\n| cancel from SUSPENDED | also `{ type: \"resume_service\" }` |\n\n",
  "labels": [
    {
      "id": "LA_kwDORJouOc8AAAACX7LG3A",
      "name": "spec",
      "description": "Specification issue",
      "color": "0052CC"
    }
  ],
  "number": 1,
  "title": "[SPEC] Dunning System - billing reminder state machine"
}