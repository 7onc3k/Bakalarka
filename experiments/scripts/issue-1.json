{"body":"## 1. Requirements\n\n*Problem domain — WHAT the business needs*\n\n### Description\n\nA standalone npm package implementing a dunning system (automated billing reminder workflow) as pure business logic. The system automatically escalates unpaid invoices through a series of states — from a friendly due-soon reminder, through increasingly urgent notices, to service suspension and eventual write-off.\n\nEach invoice has an independent dunning instance. The package contains no infrastructure dependencies — it returns action descriptors (send email, suspend service, schedule next check) rather than performing them. Timeouts are calculated in business days (excluding weekends and public holidays).\n\nThe system supports configurable timeouts per dunning instance, configurable public holidays for business day calculations, manual overrides (pause, resume, force advance), and invoice cancellation at any point.\n\n### Acceptance Criteria\n\n**Time-based transitions (happy path escalation):**\n\n- Given an invoice is in ISSUED state\n  When 7 business days before the due date is reached\n  Then the state transitions to DUE_SOON\n  And an action descriptor `send_email(due_soon_reminder)` is returned\n\n- Given an invoice is in DUE_SOON state\n  When the due date is reached\n  Then the state transitions to OVERDUE\n\n- Given an invoice is in OVERDUE state\n  When 3 business days have elapsed\n  Then the state transitions to GRACE\n\n- Given an invoice is in GRACE state\n  When 7 business days have elapsed\n  Then the state transitions to REMINDER_1\n  And an action descriptor `send_email(first_reminder)` is returned\n\n- Given an invoice is in REMINDER_1 state\n  When 14 business days have elapsed\n  Then the state transitions to REMINDER_2\n  And an action descriptor `send_email(second_reminder)` is returned\n\n- Given an invoice is in REMINDER_2 state\n  When 14 business days have elapsed\n  Then the state transitions to FINAL_NOTICE\n  And an action descriptor `send_email(final_warning)` is returned\n\n- Given an invoice is in FINAL_NOTICE state\n  When 7 business days have elapsed\n  Then the state transitions to SUSPENDED\n  And action descriptors `suspend_service()` and `send_email(service_suspended)` are returned\n\n- Given an invoice is in SUSPENDED state\n  When 30 business days have elapsed\n  Then the state transitions to WRITTEN_OFF\n  And an action descriptor `send_email(written_off_notice)` is returned\n\n**Payment (resolves dunning at any point):**\n\n- Given an invoice is in any state except WRITTEN_OFF, PAID, and CANCELLED\n  When a `payment_received` event occurs\n  Then the state transitions to PAID\n\n- Given an invoice was in SUSPENDED state\n  When a `payment_received` event transitions it to PAID\n  Then an action descriptor `resume_service()` is returned in addition to the transition\n\n**Terminal states:**\n\n- Given an invoice is in PAID state\n  When any event occurs\n  Then no state transition happens\n\n- Given an invoice is in WRITTEN_OFF state\n  When any event occurs\n  Then no state transition happens\n\n- Given an invoice is in CANCELLED state\n  When any event occurs\n  Then no state transition happens\n\n**Invoice cancellation:**\n\n- Given an invoice is in any state except PAID, WRITTEN_OFF, and CANCELLED\n  When an `invoice_cancelled` event occurs\n  Then the state transitions to CANCELLED\n\n- Given an invoice was in SUSPENDED state\n  When an `invoice_cancelled` event transitions it to CANCELLED\n  Then an action descriptor `resume_service()` is returned\n\n**Pause / Resume (manual override):**\n\n- Given an invoice is in any active dunning state (OVERDUE, GRACE, REMINDER_1, REMINDER_2, FINAL_NOTICE, SUSPENDED)\n  When a `dunning_paused` event occurs\n  Then the state transitions to PAUSED\n  And the previous state and elapsed time are preserved\n\n- Given an invoice is in PAUSED state\n  When a `dunning_resumed` event occurs\n  Then the state transitions back to the state it was in before pausing\n  And the timeout resumes from where it left off\n\n- Given an invoice is in PAUSED state\n  When a `payment_received` event occurs\n  Then the state transitions to PAID (payment always takes priority)\n\n- Given an invoice is in PAUSED state\n  When an `invoice_cancelled` event occurs\n  Then the state transitions to CANCELLED\n\n**Manual advance:**\n\n- Given an invoice is in any active dunning state\n  When a `manual_advance` event occurs\n  Then the state transitions to the next state in the escalation sequence\n  And the appropriate action descriptors for that transition are returned\n\n**Configurable timeouts:**\n\n- Given a dunning instance is created with custom timeout configuration\n  When time-based transitions are evaluated\n  Then the custom timeouts are used instead of the defaults\n\n- Given no custom timeout configuration is provided\n  When a dunning instance is created\n  Then the default timeouts are used (DUE_SOON: 7d before due, OVERDUE→GRACE: 3bd, GRACE→REMINDER_1: 7bd, REMINDER_1→REMINDER_2: 14bd, REMINDER_2→FINAL_NOTICE: 14bd, FINAL_NOTICE→SUSPENDED: 7bd, SUSPENDED→WRITTEN_OFF: 30bd)\n\n**Business days calculation:**\n\n- Given a timeout of 14 business days starting on a Friday\n  When the system calculates the target date\n  Then weekends (Saturday, Sunday) are excluded from the count\n\n- Given a public holiday falls within a timeout period\n  When the system calculates the target date\n  Then the public holiday is excluded from the count\n\n- Given a custom holiday calendar is provided\n  When business days are calculated\n  Then the custom holidays are used\n\n### Domain Glossary\n\n- **Dunning** — the process of escalating unpaid invoices through a series of reminders\n- **Dunning instance** — an independent dunning process for a single invoice\n- **Grace period** — a waiting period after the due date to account for bank transfer delays (1-3 days)\n- **Business days** — working days excluding weekends and public holidays\n- **Due date** — the payment deadline on an invoice\n- **Suspension** — disabling services for the client as a consequence of non-payment\n- **Write-off** — marking a receivable as uncollectible; terminal state handled outside the system\n- **Action descriptor** — a plain object describing what the consuming application should do (e.g. send email, suspend service), without performing it\n- **Holiday calendar** — a configurable list of public holidays for business day calculations\n\n### Out of Scope\n\nThe following are explicitly **not** part of this package:\n- **Payment retry** (e.g. Stripe retry) — infrastructure concern\n- **Late fees / interest calculation** — separate accounting concern\n- **Partial payments** — would require threshold/credit logic, out of scope\n- **Email sending** — the package returns action descriptors, not performs them\n- **Scheduling / cron** — the consuming application decides when to evaluate timeouts\n- **Database persistence** — the consuming application manages state storage\n\n---\n\n---\n\n---\n\n## 2. Architecture\n\n*Structure — HOW the solution is organized*\n\n### Type Definitions\n\n```typescript\n// ── States ──────────────────────────────────────────────────────────\ntype DunningState =\n  | 'ISSUED' | 'DUE_SOON' | 'OVERDUE' | 'GRACE'\n  | 'REMINDER_1' | 'REMINDER_2' | 'FINAL_NOTICE'\n  | 'SUSPENDED' | 'WRITTEN_OFF'\n  | 'PAID' | 'PAUSED' | 'CANCELLED';\n\n// ── Events ──────────────────────────────────────────────────────────\ntype DunningEventType =\n  | 'DAY_PASSED'           // cron tick — system evaluates timeouts\n  | 'PAYMENT_RECEIVED'     // payment arrived\n  | 'INVOICE_CANCELLED'    // invoice voided\n  | 'DUNNING_PAUSED'       // manual pause\n  | 'DUNNING_RESUMED'      // manual resume\n  | 'MANUAL_ADVANCE';      // manual escalation to next state\n\ninterface DunningEvent {\n  type: DunningEventType;\n  timestamp: Date;\n}\n\n// ── Actions ─────────────────────────────────────────────────────────\ntype ActionType =\n  | 'SEND_EMAIL'\n  | 'SUSPEND_SERVICE'\n  | 'RESUME_SERVICE';\n\ninterface ActionDescriptor {\n  type: ActionType;\n  template?: string;   // e.g. 'due_soon_reminder', 'first_reminder', 'final_warning'\n}\n\n// ── Configuration ───────────────────────────────────────────────────\ninterface DunningConfig {\n  timeouts: Partial<Record<DunningState, number>>;  // business days per state\n  holidays: Date[];                                   // public holiday calendar\n}\n\n// ── Dunning Instance ────────────────────────────────────────────────\ninterface DunningInstance {\n  invoiceId: string;\n  dueDate: Date;\n  state: DunningState;\n  stateEnteredAt: Date;\n  config: DunningConfig;\n  pausedFrom?: DunningState;     // preserved when pausing\n  pausedElapsed?: number;         // business days already elapsed when paused\n}\n\n// ── Transition Result ───────────────────────────────────────────────\ninterface TransitionResult {\n  newState: DunningState;\n  actions: ActionDescriptor[];\n}\n```\n\n### Invariants\n\n1. **Defined transitions only** — State transitions may only occur through edges defined in the behavioral model. No direct jumps between arbitrary states.\n2. **Terminal states are final** — PAID, WRITTEN_OFF, and CANCELLED accept no further transitions. Any event received in these states is a no-op.\n3. **Payment always wins** — A `PAYMENT_RECEIVED` event takes priority over any other pending transition, including from PAUSED state.\n4. **Business days only** — All time-based calculations exclude weekends (Saturday, Sunday) and configured public holidays.\n5. **Pause preserves context** — When entering PAUSED, the previous state and elapsed business days must be stored. Resume restores both.\n6. **Resume restores exactly** — After resume, the timeout continues from where it left off (remaining = configured timeout − elapsed before pause).\n7. **Pause scope** — Only active dunning states can be paused: OVERDUE, GRACE, REMINDER_1, REMINDER_2, FINAL_NOTICE, SUSPENDED. ISSUED and DUE_SOON cannot be paused.\n8. **Action descriptors are pure data** — The package never performs side effects. It returns action descriptors that the consuming application executes.\n\n### Behavioral Model\n\n\n```mermaid\nstateDiagram-v2\n    direction LR\n\n    [*] --> ISSUED\n    ISSUED --> DUE_SOON : 7bd before due\n    DUE_SOON --> OVERDUE : due date reached\n    OVERDUE --> GRACE : 3bd\n    GRACE --> REMINDER_1 : 7bd\n    REMINDER_1 --> REMINDER_2 : 14bd\n    REMINDER_2 --> FINAL_NOTICE : 14bd\n    FINAL_NOTICE --> SUSPENDED : 7bd\n    SUSPENDED --> WRITTEN_OFF : 30bd\n\n    OVERDUE --> PAUSED : paused\n    GRACE --> PAUSED : paused\n    REMINDER_1 --> PAUSED : paused\n    PAUSED --> OVERDUE : resumed\n    PAUSED --> GRACE : resumed\n    PAUSED --> REMINDER_1 : resumed\n\n    PAID --> [*]\n    WRITTEN_OFF --> [*]\n    CANCELLED --> [*]\n```\n\n> **Note:** The diagram shows only the main escalation flow and pause/resume.\n> **Payment** (→ PAID) and **Cancellation** (→ CANCELLED) can occur from **any non-terminal state** — see Transition Table below for complete mapping.\n> Pause/resume also applies to REMINDER_2, FINAL_NOTICE, SUSPENDED (omitted for readability).\n> \"bd\" = business days.\n\n\n**Transition Table:**\n\n| From | Event | To | Actions |\n|------|-------|----|---------|\n| ISSUED | 7bd before due | DUE_SOON | `send_email(due_soon_reminder)` |\n| DUE_SOON | due date reached | OVERDUE | — |\n| OVERDUE | 3bd elapsed | GRACE | — |\n| GRACE | 7bd elapsed | REMINDER_1 | `send_email(first_reminder)` |\n| REMINDER_1 | 14bd elapsed | REMINDER_2 | `send_email(second_reminder)` |\n| REMINDER_2 | 14bd elapsed | FINAL_NOTICE | `send_email(final_warning)` |\n| FINAL_NOTICE | 7bd elapsed | SUSPENDED | `suspend_service()`, `send_email(service_suspended)` |\n| SUSPENDED | 30bd elapsed | WRITTEN_OFF | `send_email(written_off_notice)` |\n| _any non-terminal_ | payment_received | PAID | `resume_service()` if from SUSPENDED |\n| _any non-terminal_ | invoice_cancelled | CANCELLED | `resume_service()` if from SUSPENDED |\n| _active dunning_ | dunning_paused | PAUSED | — |\n| PAUSED | dunning_resumed | _(previous state)_ | — |\n| _any active_ | manual_advance | _(next in sequence)_ | _(actions for that transition)_ |\n\n### Technical Constraints\n\n- **Language:** TypeScript (strict mode)\n- **Package:** npm package, ES modules + CommonJS dual export\n- **Pure logic:** No side effects, no I/O, no runtime dependencies\n- **Exports:** `transition(instance, event): TransitionResult`, `createInstance(invoiceId, dueDate, config?): DunningInstance`, all types\n- **Node.js:** ≥18 (native Date handling)\n- **Testing:** Vitest, 100% branch coverage target\n- **Mutation testing:** Stryker for test quality validation\n","labels":[{"id":"LA_kwDORJouOc8AAAACX7LG3A","name":"spec","description":"Specification issue","color":"0052CC"}],"number":1,"title":"[SPEC] Dunning System - billing reminder state machine"}
